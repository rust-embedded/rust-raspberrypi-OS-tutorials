# æ•™ç¨‹06 - UARTé“¾åŠ è½½å™¨

## tl;dr

- ä»SDå¡ä¸Šè¿è¡Œæ˜¯ä¸€æ¬¡ä¸é”™çš„ä½“éªŒï¼Œä½†æ˜¯æ¯æ¬¡éƒ½ä¸ºæ¯ä¸ªæ–°çš„äºŒè¿›åˆ¶æ–‡ä»¶è¿™æ ·åšå°†éå¸¸ç¹çã€‚
  å› æ­¤ï¼Œè®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ª[chainloader]ã€‚
- è¿™å°†æ˜¯æ‚¨éœ€è¦æ”¾åœ¨SDå¡ä¸Šçš„æœ€åä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ã€‚
  æ¯ä¸ªåç»­çš„æ•™ç¨‹éƒ½å°†åœ¨`Makefile`ä¸­æä¾›ä¸€ä¸ª`chainboot`ï¼Œè®©æ‚¨æ–¹ä¾¿åœ°é€šè¿‡`UART`åŠ è½½å†…æ ¸ã€‚

[chainloader]: https://en.wikipedia.org/wiki/Chain_loading


## æ³¨æ„

è¯·æ³¨æ„ï¼Œè¿™ä¸ªæ•™ç¨‹ä¸­æœ‰ä¸€äº›å†…å®¹ä»…é€šè¿‡æŸ¥çœ‹æºä»£ç å¾ˆéš¾ç†è§£ã€‚

å¤§è‡´çš„æ„æ€æ˜¯ï¼Œåœ¨`boot.s`ä¸­ï¼Œæˆ‘ä»¬ç¼–å†™äº†ä¸€æ®µ[position independent code]ä»£ç ï¼Œ
å®ƒä¼šè‡ªåŠ¨ç¡®å®šå›ºä»¶åŠ è½½äºŒè¿›åˆ¶æ–‡ä»¶çš„ä½ç½®ï¼ˆ`0x8_0000`ï¼‰ï¼Œä»¥åŠé“¾æ¥åˆ°çš„ä½ç½®ï¼ˆ`0x200_0000`ï¼Œå‚è§ `kernel.ld`ï¼‰ã€‚
ç„¶åï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶å°†è‡ªèº«ä»åŠ è½½åœ°å€å¤åˆ¶åˆ°é“¾æ¥åœ°å€ï¼ˆä¹Ÿå°±æ˜¯"é‡å®šä½"è‡ªèº«ï¼‰ï¼Œç„¶åè·³è½¬åˆ°`_start_rust()`çš„é‡å®šä½ç‰ˆæœ¬ã€‚

ç”±äºé“¾åŠ è½½ç¨‹åºç°åœ¨å·²ç»"è„±ç¦»äº†è·¯å¾„"ï¼Œå®ƒç°åœ¨å¯ä»¥ä»`UART`æ¥æ”¶å¦ä¸€ä¸ªå†…æ ¸äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶å°†å…¶å¤åˆ¶åˆ°RPiå›ºä»¶çš„æ ‡å‡†åŠ è½½åœ°å€`0x8_0000`ã€‚
æœ€åï¼Œå®ƒè·³è½¬åˆ°`0x8_0000`ï¼Œæ–°åŠ è½½çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¼šé€æ˜åœ°æ‰§è¡Œï¼Œå°±å¥½åƒå®ƒä¸€ç›´ä»SDå¡åŠ è½½ä¸€æ ·ã€‚

åœ¨æˆ‘æœ‰æ—¶é—´è¯¦ç»†å†™ä¸‹è¿™äº›å†…å®¹ä¹‹å‰ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚ç›®å‰ï¼Œè¯·å°†è¿™ä¸ªæ•™ç¨‹è§†ä¸ºä¸€ç§ä¾¿åˆ©åŠŸèƒ½çš„å¯ç”¨ç¨‹åºï¼Œå®ƒå…è®¸å¿«é€Ÿå¯åŠ¨ä»¥ä¸‹æ•™ç¨‹ã€‚
_å¯¹äºé‚£äº›æ¸´æœ›æ·±å…¥äº†è§£çš„äººï¼Œå¯ä»¥ç›´æ¥è·³åˆ°ç¬¬[15ç« ](../15_virtual_mem_part3_precomputed_tables)ï¼Œé˜…è¯»READMEçš„å‰åŠéƒ¨åˆ†ï¼Œ
å…¶ä¸­è®¨è®ºäº†`Load Address != Link Address`çš„é—®é¢˜_ã€‚

[position independent code]: https://en.wikipedia.org/wiki/Position-independent_code

## å®‰è£…å¹¶æµ‹è¯•å®ƒ

æˆ‘ä»¬çš„é“¾åŠ è½½ç¨‹åºç§°ä¸º`MiniLoad`ï¼Œå—åˆ°äº†[raspbootin]çš„å¯å‘ã€‚

æ‚¨å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ•™ç¨‹å°è¯•å®ƒï¼š
1. æ ¹æ®æ‚¨çš„ç›®æ ‡ç¡¬ä»¶è¿è¡Œå‘½ä»¤ï¼š`make`æˆ–`BSP=rpi4 make`ã€‚
1. å°†`kernel8.img`å¤åˆ¶åˆ°SDå¡ä¸­ï¼Œå¹¶å°†SDå¡é‡æ–°æ’å…¥æ‚¨çš„RPiã€‚
1. è¿è¡Œå‘½ä»¤`make chainboot`æˆ–`BSP=rpi4 make chainboot`ã€‚
1. å°†USBä¸²å£è¿æ¥åˆ°æ‚¨çš„ä¸»æœºPCä¸Šã€‚
    - è¯·å‚è€ƒ[top-level README](../README.md#-usb-serial-output)ä¸­çš„æ¥çº¿å›¾ã€‚
    - ç¡®ä¿æ‚¨**æ²¡æœ‰**è¿æ¥USBä¸²å£çš„ç”µæºå¼•è„šï¼Œåªè¿æ¥RX/TXå’ŒGNDã€‚
1. å°†RPiè¿æ¥åˆ°ï¼ˆUSBï¼‰ç”µæºçº¿ã€‚
1. è§‚å¯ŸåŠ è½½ç¨‹åºé€šè¿‡`UART`è·å–å†…æ ¸ï¼š

> â— **æ³¨æ„**: `make chainboot`å‡è®¾é»˜è®¤çš„ä¸²è¡Œè®¾å¤‡åç§°ä¸º`/dev/ttyUSB0`ã€‚æ ¹æ®æ‚¨çš„ä¸»æœºæ“ä½œç³»ç»Ÿï¼Œè®¾å¤‡åç§°å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚
> ä¾‹å¦‚ï¼Œåœ¨`macOS`ä¸Šï¼Œå®ƒå¯èƒ½æ˜¯ç±»ä¼¼äº`/dev/tty.usbserial-0001`çš„åç§°ã€‚
> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯·æ˜ç¡®ç»™å‡ºè®¾å¤‡åç§°ï¼š


```console
$ DEV_SERIAL=/dev/tty.usbserial-0001 make chainboot
```

[raspbootin]: https://github.com/mrvn/raspbootin

```console
$ make chainboot
[...]
Minipush 1.0

[MP] â³ Waiting for /dev/ttyUSB0
[MP] âœ… Serial connected
[MP] ğŸ”Œ Please power the target now

 __  __ _      _ _                 _
|  \/  (_)_ _ (_) |   ___  __ _ __| |
| |\/| | | ' \| | |__/ _ \/ _` / _` |
|_|  |_|_|_||_|_|____\___/\__,_\__,_|

           Raspberry Pi 3

[ML] Requesting binary
[MP] â© Pushing 7 KiB ==========================================ğŸ¦€ 100% 0 KiB/s Time: 00:00:00
[ML] Loaded! Executing the payload now

[0] mingo version 0.5.0
[1] Booting on: Raspberry Pi 3
[2] Drivers loaded:
      1. BCM PL011 UART
      2. BCM GPIO
[3] Chars written: 117
[4] Echoing input now
```

åœ¨è¿™ä¸ªæ•™ç¨‹ä¸­ï¼Œä¸ºäº†æ¼”ç¤ºç›®çš„ï¼ŒåŠ è½½äº†ä¸Šä¸€ä¸ªæ•™ç¨‹ä¸­çš„å†…æ ¸ç‰ˆæœ¬ã€‚åœ¨åç»­çš„æ•™ç¨‹ä¸­ï¼Œå°†ä½¿ç”¨å·¥ä½œç›®å½•çš„å†…æ ¸ã€‚

## æµ‹è¯•å®ƒ

è¿™ä¸ªæ•™ç¨‹ä¸­çš„`Makefile`æœ‰ä¸€ä¸ªé¢å¤–çš„ç›®æ ‡`qemuasm`ï¼Œå®ƒå¯ä»¥è®©ä½ å¾ˆå¥½åœ°è§‚å¯Ÿåˆ°å†…æ ¸åœ¨é‡æ–°å®šä½åå¦‚ä½•ä»åŠ è½½åœ°å€åŒºåŸŸï¼ˆ`0x80_XXX`ï¼‰
è·³è½¬åˆ°é‡æ–°å®šä½çš„ä»£ç ï¼ˆ`0x0200_0XXX`ï¼‰ï¼š

```console
$ make qemuasm
[...]
N:
0x00080030:  58000140  ldr      x0, #0x80058
0x00080034:  9100001f  mov      sp, x0
0x00080038:  58000141  ldr      x1, #0x80060
0x0008003c:  d61f0020  br       x1

----------------
IN:
0x02000070:  9400044c  bl       #0x20011a0

----------------
IN:
0x020011a0:  90000008  adrp     x8, #0x2001000
0x020011a4:  90000009  adrp     x9, #0x2001000
0x020011a8:  f9446508  ldr      x8, [x8, #0x8c8]
0x020011ac:  f9446929  ldr      x9, [x9, #0x8d0]
0x020011b0:  eb08013f  cmp      x9, x8
0x020011b4:  54000109  b.ls     #0x20011d4
[...]
```

## ç›¸æ¯”ä¹‹å‰çš„å˜åŒ–ï¼ˆdiffï¼‰
è¯·æ£€æŸ¥[è‹±æ–‡ç‰ˆæœ¬](README.md#diff-to-previous)ï¼Œè¿™æ˜¯æœ€æ–°çš„ã€‚